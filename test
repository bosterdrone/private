local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local workspace = game:GetService("Workspace")

local Player = Players.LocalPlayer or Players.PlayerAdded:Wait()
local Remotes = ReplicatedStorage:WaitForChild("Remotes", 9e9)
local Balls = workspace:WaitForChild("Balls", 9e9)

local function print(...)
    if Debug then
        warn(...)
    end
end

local function VerifyBall(Ball)
    return typeof(Ball) == "Instance" and Ball:IsA("BasePart") and Ball:IsDescendantOf(Balls) and Ball:GetAttribute("realBall") == true
end

local function IsTarget()
    return Player.Character and Player.Character:FindFirstChild("Highlight")
end

local function Parry()
    Remotes:WaitForChild("ParryButtonPress"):Fire()
end

local function CheckForParry()
    local Character = Player.Character
    local HumanoidRootPart = Character and Character:FindFirstChild("HumanoidRootPart")
    if not HumanoidRootPart then
        return
    end

    local Origin = HumanoidRootPart.Position
    local Direction = HumanoidRootPart.CFrame.LookVector
    local RaycastParams = RaycastParams.new()
    RaycastParams.FilterType = Enum.RaycastFilterType.Blacklist
    RaycastParams.FilterDescendantsInstances = {workspace}
    local Result = workspace:Raycast(Origin, Direction * 100, RaycastParams)

    if Result then
        local Hit = Result.Instance
        if VerifyBall(Hit) then
            Parry()
        end
    end
end

local function UpdateBalls()
    for _, Ball in ipairs(Balls:GetChildren()) do
        if VerifyBall(Ball) then
            Ball.Touched:Connect(function(hit)
                if hit == SphereHitbox then
                    Parry()
                end
            end)
        end
    end
end

local function UpdateVisualHitbox()
    local Ball = Balls:FindFirstChildOfClass("Part")
    if Ball then
        local Calculate = Ball.Velocity.Magnitude / 4
        SphereHitbox.Size = Vector3.new(Calculate, Calculate, Calculate)
        SphereHitbox.CFrame = Player.Character.HumanoidRootPart.CFrame
    end
end

local function Main()
    local SphereHitbox = Instance.new("Part")
    SphereHitbox.Name = "VisualViewPart"
    SphereHitbox.Parent = workspace
    SphereHitbox.Color = Color3.new(0.92549, 0.831373, 1)
    SphereHitbox.Shape = Enum.PartType.Ball
    SphereHitbox.CanCollide = false
    SphereHitbox.Anchored = true
    SphereHitbox.CastShadow = false
    SphereHitbox.Transparency = 0.2
    SphereHitbox.Material = "ForceField"

    UpdateBalls()

    while true do
        CheckForParry()
        UpdateVisualHitbox()
        wait()
    end
end

Main()
